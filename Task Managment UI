# The completed Task Management App with interactyive UI using PyQt5 like the Weather App

import sys
import json
from datetime import datetime
from PyQt5.QtWidgets import (
    QApplication, QWidget, QVBoxLayout, QHBoxLayout, QLabel,
    QLineEdit, QPushButton, QListWidget, QComboBox, QMessageBox
)
from PyQt5.QtCore import Qt


# -------------------------------
#  TASK MODEL & STORAGE LOGIC
# -------------------------------
class Task:
    def __init__(self, title, category="General", priority="Medium", due_date=None, completed=False, created_at=None):
        self.title = title
        self.category = category
        self.priority = priority
        self.due_date = due_date
        self.completed = completed
        self.created_at = created_at or datetime.now().strftime("%Y-%m-%d %H:%M:%S")

    def to_dict(self):
        return self.__dict__


class TaskManager:
    def __init__(self, filename="tasks.json"):
        self.filename = filename
        self.tasks = self.load_tasks()

    def add_task(self, title, category, priority, due_date):
        new_task = Task(title, category, priority, due_date)
        self.tasks.append(new_task)
        self.save_tasks()

    def delete_task(self, index):
        if 0 <= index < len(self.tasks):
            del self.tasks[index]
            self.save_tasks()

    def complete_task(self, index):
        if 0 <= index < len(self.tasks):
            self.tasks[index].completed = True
            self.save_tasks()

    def save_tasks(self):
        try:
            with open(self.filename, "w") as f:
                json.dump([t.to_dict() for t in self.tasks], f, indent=4)
        except Exception as e:
            print(f"Error saving tasks: {e}")

    def load_tasks(self):
        try:
            with open(self.filename, "r") as f:
                return [Task(**t) for t in json.load(f)]
        except FileNotFoundError:
            return []
        except Exception as e:
            print(f"Error loading tasks: {e}")
            return []


# -------------------------------
#  TASK MANAGER UI
# -------------------------------
class TaskManagerApp(QWidget):
    def __init__(self):
        super().__init__()
        self.manager = TaskManager()
        self.task_input = QLineEdit()
        self.category_input = QLineEdit()
        self.priority_box = QComboBox()
        self.due_date_input = QLineEdit()
        self.task_list = QListWidget()
        self.add_button = QPushButton("Add Task")
        self.delete_button = QPushButton("Delete Task")
        self.complete_button = QPushButton("Mark Complete")
        self.setup_ui()
        self.refresh_tasks()

    def setup_ui(self):
        layout = QVBoxLayout()

        title_label = QLabel("<h1>✅ Task Manager ❌</h1>")
        title_label.setAlignment(Qt.AlignCenter)
        layout.addWidget(title_label)

        self.task_input.setPlaceholderText("Task title...")
        self.category_input.setPlaceholderText("Category (e.g., School, Work)...")
        self.priority_box.addItems(["Low", "Medium", "High"])
        self.due_date_input.setPlaceholderText("Due date (optional)...")

        layout.addWidget(self.task_input)
        layout.addWidget(self.category_input)
        layout.addWidget(self.priority_box)
        layout.addWidget(self.due_date_input)
        layout.addWidget(self.add_button)
        layout.addWidget(self.task_list)

        btn_layout = QHBoxLayout()
        btn_layout.addWidget(self.complete_button)
        btn_layout.addWidget(self.delete_button)
        layout.addLayout(btn_layout)

        self.setLayout(layout)
        self.setWindowTitle("Task Manager ")

        # Styling
        self.setStyleSheet("""
            QLineEdit, QComboBox { font-size: 18px; padding: 6px; }
            QPushButton { font-size: 18px; padding: 8px; font-weight: bold; }
            QListWidget { font-size: 16px; }
            QMessageBox { font-size: 16px; font-weight: bold; color: red; }
            
        """)

        # Events
        self.add_button.clicked.connect(self.add_task)
        self.delete_button.clicked.connect(self.delete_task)
        self.complete_button.clicked.connect(self.complete_task)

    def add_task(self):
        title = self.task_input.text().strip()
        if not title:
            QMessageBox.warning(self, "Error", "Task title cannot be empty!")
            return

        category = self.category_input.text().strip() or "General"
        priority = self.priority_box.currentText()
        due_date = self.due_date_input.text().strip() or None
        self.manager.add_task(title, category, priority, due_date)

        self.task_input.clear()
        self.category_input.clear()
        self.due_date_input.clear()
        self.refresh_tasks()

    def delete_task(self):
        row = self.task_list.currentRow()
        if row >= 0:
            confirm = QMessageBox.question(self, "Delete Task", "Are you sure you want to delete this task?", QMessageBox.Yes | QMessageBox.No)
            if confirm == QMessageBox.Yes:
                self.manager.delete_task(row)
                self.refresh_tasks()

    def complete_task(self):
        row = self.task_list.currentRow()
        if row >= 0:
            self.manager.complete_task(row)
            self.refresh_tasks()

    def refresh_tasks(self):
        self.task_list.clear()
        for task in self.manager.tasks:
            status = "✅" if task.completed else "❌"
            self.task_list.addItem(f"{status} {task.title} ({task.priority}) - {task.category} | Due: {task.due_date or 'N/A'}")


# -------------------------------
#  RUN APP
# -------------------------------
def main(argv=None):
    """Start the Task Manager GUI.

    Args:
        argv: list of command-line arguments (defaults to sys.argv)

    Returns:
        The integer exit code from QApplication.exec_()
    """
    argv = argv or sys.argv
    app = QApplication(argv)
    window = TaskManagerApp()
    window.resize(600, 700)
    window.show()
    return app.exec_()


if __name__ == "__main__":
    sys.exit(main())
